<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/Coach.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/open-physiology/boxer" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Coach.js~Coach.html">Coach</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-elementController">elementController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-handleBoxer">handleBoxer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">artefacts</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/artefacts/Box.js~Box.html">Box</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/artefacts/BoxBorder.js~BoxBorder.html">BoxBorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/artefacts/BoxCorner.js~BoxCorner.html">BoxCorner</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/artefacts/Canvas.js~Canvas.html">Canvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/artefacts/Edge.js~Edge.html">Edge</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/artefacts/Glyph.js~Glyph.html">Glyph</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/artefacts/LineSegment.js~LineSegment.html">LineSegment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/artefacts/SvgArtefact.js~SvgArtefact.html">SvgArtefact</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/artefacts/SvgTransformable.js~SvgTransformable.html">SvgTransformable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BORDER_WIDTH">BORDER_WIDTH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MIN_MIN_SIZE">MIN_MIN_SIZE</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">handlers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/handlers/Handler.js~Handler.html">Handler</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">tools</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/ClickTool.js~ClickTool.html">ClickTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/DeleteTool.js~DeleteTool.html">DeleteTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/DrawTool.js~DrawTool.html">DrawTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/GlobalBehaviorTool.js~GlobalBehaviorTool.html">GlobalBehaviorTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/HelperTool.js~HelperTool.html">HelperTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/HighlightTool.js~HighlightTool.html">HighlightTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/MouseCursorTool.js~MouseCursorTool.html">MouseCursorTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/MouseTool.js~MouseTool.html">MouseTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/MoveTool.js~MoveTool.html">MoveTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/PanTool.js~PanTool.html">PanTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/ResizeTool.js~ResizeTool.html">ResizeTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/RotateTool.js~RotateTool.html">RotateTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/SelectTool.js~SelectTool.html">SelectTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/Tool.js~Tool.html">Tool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools/ZoomTool.js~ZoomTool.html">ZoomTool</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">util</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util/Machine.js~Machine.html">Machine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util/svg.js~Point2D.html">Point2D</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util/svg.js~Vector2D.html">Vector2D</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-callIfFunction">callIfFunction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emitWhenComplete">emitWhenComplete</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sineWave">sineWave</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-strictSubclassOf">strictSubclassOf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-subclassOf">subclassOf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-withLatestFrom">withLatestFrom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCTM">getCTM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-matrixEquals">matrixEquals</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-moveToFront">moveToFront</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rotateAroundPoint">rotateAroundPoint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scaleFromPoint">scaleFromPoint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setCTM">setCTM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-snap45">snap45</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-animationFrames">animationFrames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ID_MATRIX">ID_MATRIX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-M11">M11</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-M12">M12</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-M21">M21</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-M22">M22</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MX">MX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MY">MY</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ORIG_POINT">ORIG_POINT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SVGMatrix">SVGMatrix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SVGPoint">SVGPoint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-MachineLink">MachineLink</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Coach.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {camelCase, isFunction} from &apos;lodash-bound&apos;;
import assert                  from &apos;power-assert&apos;;
import {Observable}            from &apos;./libs/expect-rxjs.js&apos;;
import $                       from &apos;./libs/jquery.js&apos;;
import Machine                 from &apos;./util/Machine&apos;;
import {Point2D}               from &apos;./util/svg&apos;;
import {ValueTracker}          from &apos;utilities&apos;;

const $$domEvents   = Symbol(&apos;$$domEvents&apos;);
const $$tools       = Symbol(&apos;$$tools&apos;);
const $$initialized = Symbol(&apos;$$initialized&apos;);


/**
 * The central hub of the artefacts and tools of a boxer canvas.
 * Creating one is among the first steps in using the boxer library.
 */
export class Coach extends ValueTracker {
	
	/**
	 * the main state machine toggling between `&apos;IDLE&apos;` and `&apos;BUSY&apos;`,
	 * used to coordinate between the local state machines of tools
	 * @type {Machine}
	 */
	stateMachine = new Machine(&apos;Coach&apos;, { state: &apos;IDLE&apos; });
	
	/**
	 * Create a new `Coach` instance rooted at a specific `Canvas` artefact.
	 * @param options
	 * @param {Canvas} options.root - the canvas making up the root of our boxer svg artefact tree
	 */
	constructor(options) {
		super();
		const {root} = options;
		this.root = root;
		this[$$domEvents] = {};
		
		// /* keep track of canvas offset */
		// this._offset = {
		// 	left: 0,
		// 	top: 0
		// };
		// setInterval(() =&gt; {
		// 	this._offset = this.root.svg.main.offset();
		// }, 1000);
	}
	
	/**
	 * Register a new tool. Assumes that the coach has not yet started.
	 * @param {Tool} tool - the new tool
	 * @return {Coach} this coach object
	 */
	addTool(tool) {
		assert(!this[$$initialized], &quot;You can&apos;t add tools to a Coach after starting it.&quot;);
		this[tool.constructor.name::camelCase()] = tool;
		if (!this[$$tools]) { this[$$tools] = new Set }
		this[$$tools].add(tool);
		tool.init({ coach: this });
		return this;
	}
	
	/**
	 * Activate a given set of registered tools and turn off all others.
	 * @param {Iterable&lt;Tool&gt;} chosenTools - the tools to activate
	 */
	activateExclusiveTools(chosenTools) {
		chosenTools = [...chosenTools];
		for (let tool of this[$$tools]) {
			let makeActive =
				chosenTools.includes(tool)                  ||
				chosenTools.includes(tool.constructor)      ||
				chosenTools.includes(tool.constructor.name) ||
				chosenTools.includes(tool.constructor.name::camelCase());
			if (makeActive !== tool.active) {
				tool.active = makeActive;
			}
		}
	}
	
	/**
	 * Start this coach, indicating that all tools have been registered.
	 */
	start() {
		this[$$initialized] = true;
		for (let tool of this[$$tools]) {
			if (tool.postInit::isFunction()) {
				tool.postInit({ coach: this });
			}
		}
	}
	
	/**
	 * Let the coach know that it should start listening to specific types
	 * of DOM events on artefacts, and to provide a way to subscribe to them.
	 * It uses jQuery&apos;s delegation feature, so it is relatively efficient,
	 * and it normalizes event objects and supplies them with additional
	 * quick-access data, like the mouse event coordinates as a `Point2D`.
	 * @param {Array&lt;string&gt;} events - a set of DOM event names, e.g., `&apos;click&apos;`, `&apos;mouseover&apos;`
	 */
	registerArtefactEvent(...events) {
		for (let e of events) {
			if (!this[$$domEvents][e]) {
				this[$$domEvents][e] = Observable.merge(
					Observable.fromEventPattern(
						(fn) =&gt; { $(this.root.svg.main).on (e, &apos;.boxer &gt; .handles *&apos;, fn) },
						(fn) =&gt; { $(this.root.svg.main).off(e, &apos;.boxer &gt; .handles *&apos;, fn) }
					),
					Observable.fromEventPattern(
						(fn) =&gt; { $(this.root.svg.main).on (e, fn) },
						(fn) =&gt; { $(this.root.svg.main).off(e, fn) }
					)
				).do(::this.enrichMouseEvent);
			}
		}
	}
	
	/**
	 * Enrich a mouse event object with a `Point2D` object representing
	 * screen coordinates.
	 * @private
	 * @param {jQuery.Event} event - a jQuery event object
	 */
	enrichMouseEvent(event) {
		event.stopPropagation();
		event.point = new Point2D({
			x:                event.pageX,
			y:                event.pageY,
			coordinateSystem: this.root.svg.main
		});
	}
	
	/**
	 * @param {String} e - the type of event to get a stream of
	 * @returns {Observable} a stream of `e` events on the root canvas element
	 */
	rootE(e) { return Observable.fromEvent($(this.root.svg.main), e).do(::this.enrichMouseEvent) }
	
	/**
	 * @param {String} e - the type of event to get a stream of
	 * @returns {Observable} a stream of `e` events on the `window` DOM element
	 */
	windowE(e) { return Observable.fromEvent($(window), e).do(::this.enrichMouseEvent) }
	
	/**
	 * @param {String} e - the type of event to get a stream of
	 * @returns {Observable} a stream of `e` events on the `document` DOM element
	 */
	documentE(e) { return Observable.fromEvent($(document), e).do(::this.enrichMouseEvent) }
	
	/**
	 * @param {String} e - the type of event to get a stream of
	 * @returns {Observable} a stream of `e` events on any artefact
	 */
	e(e) { return this[$$domEvents][e] }
	
}

/**
 * @return {SvgArtefact} the artefact controller in charge of a given SVG DOM element
 * @param {SVGElement} element - the element for which to get the controller
 */
export function elementController(element) {
	element = $(element instanceof $.Event ? element.target : element); // take an event or an element
	let controller = null;
	do {
		controller = element.data(&apos;boxer-controller&apos;);
		element = element.parent();
	} while (!controller &amp;&amp; element.length &gt; 0);
	return controller;
}


/** @private */
export function getHandler(key) {
	if (this) { return this.handlers[key] }
	return (artefact) =&gt; artefact.handlers[key];
}

/**
 * Take an event stream and transform it into a stream of handler information
 * for only specifically requested handler types.
 * @this {Observable&lt;jQuery.Event&gt;}
 * @returns {Observable&lt;Object&gt;} information on relevant boxer handlers
 * @param {string} key - the handler type we&apos;re interested in, e.g., `&apos;clickable&apos;`, or `&apos;*&apos;` for all types
 */
export function handleBoxer(key) {
	return this
		.map((event)=&gt; {
			if (event instanceof $.Event) {
				return [event.point, elementController(event), $(event.target).data(&apos;boxer-handlers&apos;)[key]];
			} else if (event) {
				const controller = event.artefact;
				return [event.point, controller, controller.handlers[key]];
			}
		})
	    .filter(v =&gt; key === &apos;*&apos; || !!v[2])
		.map(([point, controller, handlers]) =&gt; {
			let originalArtefact = controller;
			handlers = (key === &apos;*&apos; ? {} : handlers);
			return {
				...handlers,
				handlerType: key,
				originalArtefact,
				artefact: handlers &amp;&amp; handlers.artefact || originalArtefact,
				point
			}
		});
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
